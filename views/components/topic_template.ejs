<!DOCTYPE html>
<html>
  <head>
    <%- include('../partials/header') %>
    <title><%= topic.name %></title>
  </head>
  <body>
    <main>
      <div class="container mt-5">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/topics">Topics</a></li>
            <li class="breadcrumb-item active"><%= topic.name %></li>
          </ol>
        </nav>

        <h1><%= topic.name %></h1>

        <!-- Theory Section -->
        <div class="card mb-4">
          <div class="card-body">
            <h2>Introduction</h2>
            <div class="row align-items-center">
              <div class="col-md-<%= introContent.image ? '8' : '12' %>">
                <%- introContent.text %>
              </div>
              <% if (introContent.image) { %>
                <div class="col-md-4">
                  <img 
                    src="<%= introContent.image.src %>" 
                    alt="<%= introContent.image.alt %>" 
                    class="img-fluid rounded shadow-sm"
                  />
                </div>
              <% } %>
            </div>

            <% if (theorySections && theorySections.length > 0) { %>
              <% theorySections.forEach(section => { %>
                <h3 class="mt-4"><%= section.title %></h3>
                <% if (section.type === 'accordion') { %>
                  <div class="accordion" id="<%= section.id %>">
                    <% section.items.forEach(item => { %>
                      <div class="accordion-item">
                        <h4 class="accordion-header">
                          <button 
                            class="accordion-button <%= item.expanded ? '' : 'collapsed' %>" 
                            type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#<%= item.id %>"
                          >
                            <%= item.title %>
                          </button>
                        </h4>
                        <div 
                          id="<%= item.id %>" 
                          class="accordion-collapse collapse <%= item.expanded ? 'show' : '' %>"
                        >
                          <div class="accordion-body">
                            <%- item.content %>
                          </div>
                        </div>
                      </div>
                    <% }); %>
                  </div>
                <% } else { %>
                  <%- section.content %>
                <% } %>
              <% }); %>
            <% } %>
          </div>
        </div>

        <!-- Prerequisites Warning -->
        <% if (prerequisites.length > 0) { %>
          <div class="alert alert-warning">
            <h4 class="alert-heading">Prerequisites</h4>
            <p>Before starting this topic, make sure you've completed:</p>
            <ul>
              <% prerequisites.forEach(function(prereq) { %>
                <li><a href="/topics/<%= prereq.id %>"><%= prereq.name %></a></li>
              <% }); %>
            </ul>
          </div>
        <% } %>

        <!-- Exercises Section -->
        <div class="card">
          <div class="card-body">
            <h2>Practice Exercises</h2>
            <div class="list-group">
              <% exerciseGroups.forEach(group => { %>
                <a href="/topics/<%= topic.id %>/exercises/<%= group.first_page %>" 
                  class="list-group-item list-group-item-action">
                  <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1"><%= group.exercise_type.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) %></h5>
                    <small>
                      <%= group.completed_count || 0 %>/<%= group.exercise_count %> completed
                    </small>  
                  </div>
                  <div class="progress" style="height: 5px;">
                    <div class="progress-bar" role="progressbar" 
                        style="width: <%= Math.round((group.completed_count || 0) * 100 / group.exercise_count) %>%" 
                        aria-valuenow="<%= group.completed_count || 0 %>" 
                        aria-valuemin="0" 
                        aria-valuemax="<%= group.exercise_count %>">
                    </div>
                  </div>
                  <p class="mb-1 mt-2">Practice <%= group.exercise_type.replace(/_/g, ' ') %></p>
                </a>
              <% }); %>
            </div>
          </div>
        </div>

        <div class="mt-4">
          <a href="/topics" class="btn btn-secondary">Back to Topics</a>
        </div>
      </div>
    </main>
    <%- include('../partials/footer') %>
    
    <!-- Math equation format -->
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          delimiters: [
            {left: "\\(", right: "\\)", display: false},
            {left: "\\[", right: "\\]", display: true},
            {left: "\\begin{equation}", right: "\\end{equation}", display: true}
          ],
          throwOnError: false,
          trust: true,
          strict: false
        });
      });
    </script>
  </body>
</html>