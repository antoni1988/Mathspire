<% 
function getRelativeTimeString(date) {
  const now = new Date();
  const then = new Date(date);
  const diffDays = Math.floor((now - then) / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return 'Yesterday';
  return `${diffDays} days ago`;
}
%>

<!DOCTYPE html>
<html>
  <head>
    <%- include('partials/header') %>
    <title>Mathspire - Dashboard</title>
  </head>
  <body>
    <main>
      <div class="container mt-5">
        <h1>Welcome back, <%= user.username %>!</h1>
        <!-- Last Accessed Topic -->
        <% if (recentTopics && recentTopics.length > 0) { %>
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title">Continue Learning</h5>
              <% const lastTopic = recentTopics[0]; %>
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1"><%= lastTopic.name %></h6>
                  <small class="text-muted">Last accessed: <%= getRelativeTimeString(lastTopic.last_accessed) %></small>
                </div>
                <a href="/topics/<%= lastTopic.id %>" class="btn btn-primary">Continue</a>
              </div>
            </div>
          </div>
        <% } %>
        
        <!-- Activity Tracker -->
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">
              <i class="fas fa-fire me-2"></i>Activity Tracker
            </h5>
            <div class="row text-center">
              <div class="col-md-4">
                <div class="activity-stat">
                  <h3 class="text-primary"><%= userStats.streak %></h3>
                  <p class="text-muted mb-0">Day Streak</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="activity-stat">
                  <h3 class="text-success"><%= userStats.averageDaily %></h3>
                  <p class="text-muted mb-0">Daily Average</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="activity-stat">
                  <h3 class="text-info"><%= userStats.exercisesToAverage %></h3>
                  <p class="text-muted mb-0">Exercises to Average</p>
                </div>
              </div>
            </div>
            <div class="progress mt-3" style="height: 10px;">
              <div class="progress-bar bg-success" 
                  role="progressbar" 
                  style="width: <%= (userStats.todayCompleted / userStats.averageDaily) * 100 %>%"
                  aria-valuenow="<%= userStats.todayCompleted %>" 
                  aria-valuemin="0" 
                  aria-valuemax="<%= userStats.averageDaily %>">
              </div>
            </div>
            <small class="text-muted d-block text-center mt-2">
              <%= userStats.todayCompleted %> exercises completed today
            </small>
          </div>
        </div>
        <!-- Recommended Topics -->
        <div class="row">
          <div class="col-md-6">
            <div class="card mb-4">
              <div class="card-body">
                <h5 class="card-title">Recommended Topics</h5>
                <div class="list-group">
                  <% 
                  // Filter out the last accessed topic from recommendations
                  const lastTopicId = recentTopics && recentTopics[0] ? recentTopics[0].id : null;
                  const filteredRecommended = recommendedTopics.filter(topic => topic.id !== lastTopicId);
                  filteredRecommended.slice(0, 3).forEach(function(topic) { %>
                    <a href="/topics/<%= topic.id %>" class="list-group-item list-group-item-action">
                      <%= topic.name %>
                      <small class="text-muted d-block"><%= topic.completion_rate %>% completed</small>
                    </a>
                  <% }); %>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="col-md-6">
            <div class="card mb-4">
              <div class="card-body">
                <h5 class="card-title">Recent Activity</h5>
                <div class="list-group">
                  <% recentTopics.slice(1).forEach(function(topic) { %>
                    <a href="/topics/<%= topic.id %>" class="list-group-item list-group-item-action">
                      <%= topic.name %>
                      <small class="text-muted d-block">
                        Last accessed: <%= getRelativeTimeString(topic.last_accessed) %>
                      </small>
                    </a>
                  <% }); %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Progress Card -->
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">Your Progress</h5>
            <div class="progress">
              <div
                class="progress-bar"
                role="progressbar"
                style="width: <%= progressPercentage %>%"
                aria-valuenow="<%= progressPercentage %>"
                aria-valuemin="0"
                aria-valuemax="100"
              >
                <%= progressPercentage %>% Complete
              </div>
            </div>

            <p class="mt-2">
              Completed <%= completedExercises %> out of <%= totalExercises %>
              exercises
            </p>
          </div>
        </div>

          <!-- All Topics Section -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">All Topics</h5>
                  <div class="list-group">
                    <% topics.forEach(function(topic) { %>
                    <a
                      href="/topics/<%= topic.id %>"
                      class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    >
                      <%= topic.name %>
                      <span class="badge bg-primary rounded-pill">
                        <%= topic.completion_rate || 0 %>%
                      </span>
                    </a>
                    <% }); %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <%- include('partials/footer') %>
  </body>
</html>
